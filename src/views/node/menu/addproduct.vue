<template>
    <div>
        <div>
            <Modal
                    v-model="modal" width="600" :styles="{top: '20px'}" :mask-closable="false">
                <p slot="header">
                    <span>添加产品型栏目</span>
                </p>
                <div>
                    <Form ref="productadd" :model="form" :label-width="150" :rules="AddRule" class="node-add-form">
                        <Form-item label="栏目/菜单名称" prop="name">
                            <Input type="text" v-model="form.name" placeholder="请填写栏目/菜单名字"></Input>
                        </Form-item>
                        <Form-item label="英文名" prop="generate_name">
                            <Input type="text" v-model="form.generate_name"
                                   placeholder="请填写英文名，用于生成静态页命名(不要输入.html)"></Input>
                        </Form-item>
                        <Form-item label="详情" prop="title">
                            <Input type="text" v-model="form.title" placeholder="请填写栏目的详情"></Input>
                        </Form-item>
                        <Form-item label="产品分类" prop="type_id">
                            <Select ref="select" v-model="form.type_id" style="width:200px"
                                    multiple :clearable="selects">
                                <Option-group v-for="(item,index) in this.$store.state.commondata.productType" :label="index" :key="item.id">
                                    <Option v-for="items in item" :value="items.id" :label="items.name" :key="index.id">{{
                                        items.name }}
                                    </Option>
                                </Option-group>
                            </Select>
                        </Form-item>


                        <Form-item label="分类" prop="tag_id">
                            <Select v-model="form.tag_id" ref="productselect" :clearable="selects"
                                    style="text-align: left;width:200px;"
                                    label-in-value filterable 　@on-change="changeNavtype">
                                <Option v-for="item in navtype" :value="item.id" :label="item.text" :key="item.id">
                                    {{ item.text }}
                                </Option>
                            </Select>
                        </Form-item>
                        <Form-item label="上级分类" prop="p_id">
                            <Select ref="productselect" :clearable="sele" style="width:250px;"
                                    label-in-value filterable @on-change="changeArticletype">
                                <Option v-for="item in pidtype" :value="item.id" :label="item.text" :key="item.id">
                                    {{item.text}}
                                </Option>
                            </Select>
                        </Form-item>
                        <Form-item label="列表页面模板名" prop="listtemplate">
                            <Input type="text" v-model="form.listtemplate" placeholder="请填写列表页面模板名(加.html)"></Input>
                        </Form-item>
                        <Form-item label="详情页面的相关模板名" prop="detailtemplate">
                            <Input type="text" v-model="form.detailtemplate"
                                   placeholder="请填写详情页面的相关模板名(加.html)"></Input>
                        </Form-item>
                        <Form-item label="栏目列表调取的数量" prop="listsize">
                            <Input-number :min="0" v-model="form.listsize" placeholder="请填写当前栏目列表调取的数量"></Input-number>
                        </Form-item>
                    </Form>
                </div>
                <div slot="footer">
                    <Button type="success" size="large" :loading="modal_loading" @click="addproduct">保存</Button>
                </div>
            </Modal>
        </div>
    </div>

</template>

<script type="text/ecmascript-6">
    import http from '../../../libs/http';

    export default {
        data () {
            const checkNavtype = (rule, value, callback) => {
                if (!value) {
                    callback(new Error('请选择栏目分类'));
                } else {
                    callback();
                }
            };
            const checkarticletype = (rule, value, callback) => {
                if (!value) {
                    callback(new Error('请选择分类'));
                } else {
                    callback();
                }
            };
            return {
                modal: false,
                modal_loading: false,
                type_name: '',
                form: {
                    listsize: 0,
                    p_id: '',
                    type_id: [],
                    name: '',
                    title: '',
                    flag: '5',
                    flag_name: '产品型',
                    generate_name: '',
                    type_name: ''
                },
                selects: true,
                sele: true,
                AddRule: {
                    name: [
                        {required: true, message: '请填写菜单名字', trigger: 'blur'}
                    ],
                    title: [
                        {message: '请填写栏目的详情', trigger: 'blur'}
                    ],
                    generate_name: [
                        {required: true, message: '请填写生成的文件名', trigger: 'blur'}
                    ],
                    tag_name: [
                        {validator: checkNavtype, trigger: 'blur'}
                    ]
                }
            };
        },
        methods: {

            changeNavtype (value) {
                this.form.tag_name = value.label;
                this.form.tag_id = value.value;
            },
            changeArticletype (value) {
                this.form.p_id = value.value;
            },
            addproduct () {
                this.$refs.productadd.validate((valid) => {
                    if (valid) {
                        this.modal_loading = true;
                        let data = this.form;
                        this.apiPost('menu', data).then((res) => {
                            this.handleAjaxResponse(res, (data, msg) => {
                                this.$refs.productselect.clearSingleSelect();
                                this.modal = false;

                                if (this.gpd) {
                                    this.$emit('getdata');
                                }
                                this.$Message.success(msg);
                                this.modal_loading = false;
                                this.$refs.productadd.resetFields();
                            }, (data, msg) => {
                                this.modal_loading = false;
                                this.$Message.error(msg);
                            });
                        }, (res) => {
                            // 处理错误信息
                            this.modal_loading = false;
                            this.$Message.error('网络异常，请稍后重试。');
                        });
                    }
                });
            }
        },
        mixins: [http],
        props: {
            gpd: {default: 1},

            navtype: {
                default: []
            },
            ptype: {
                default: []
            },
            pidtype: {
                default: []
            }
        }
    };
</script>
